!function(e){"use strict";var f=Promise;if(void 0===(f=void 0===f?e.Promise:f))throw"Promise is not supported! Use latest version node/browser or promise-polyfill";function p(e){return void 0===e}function l(e){return"function"==typeof e}function m(e){return"string"==typeof e}function h(e){if(v(e)){for(var r in e)if(e.hasOwnProperty(r))return;return 1}return g(e)?!e.length:!e}function y(e,r){if(g(e))return e.map(r);for(var n in e)e.hasOwnProperty(n)&&r(e[n])}var g=Array.isArray,v=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)},O={PARSE_ERROR:{code:-32700,message:"Invalid JSON was received by the server. An error occurred on the server while parsing the JSON text."},INVALID_REQUEST:{code:-32600,message:"Invalid Request. The JSON sent is not a valid Request object."},METHOD_NOT_FOUND:{code:-32601,message:"Method not found. The method does not exist / is not available."},INVALID_PARAMS:{code:-32602,message:"Invalid params. Invalid method parameter(s)."},INTERNAL_ERROR:{code:-32603,message:"Internal error. Internal JSON-RPC error."}};function R(e,r,n){this.message=r||"",this.code=e||-32e3,Boolean(n)&&(this.data=n)}R.prototype=new Error;function r(){var s=this,o={},t=0,a={};function i(e,r){e=JSON.parse(JSON.stringify(e));return r&&(v(r)&&r.hasOwnProperty("message")?e.data=r.message:m(r)&&(e.data=r),r instanceof R&&(e={message:r.message,code:r.code},r.hasOwnProperty("data")&&(e.data=r.data))),e}function u(e){try{return e.error?(t=e,void(o.hasOwnProperty(t.id)?o[t.id].reject(t.error):console.log("Unknown request",t))):(n=e).hasOwnProperty("result")&&n.hasOwnProperty("id")?(r=e,void(o.hasOwnProperty(r.id)?(o[r.id].resolve(r.result),delete o[r.id]):console.log("unknown request",r))):e.method?function(r){{if(!a.hasOwnProperty(r.method))return f.resolve({jsonrpc:"2.0",id:r.id,error:i(O.METHOD_NOT_FOUND,{message:r.method})});try{var e;if(r.hasOwnProperty("params")){if("pass"==a[r.method].params)e=a[r.method].fn.call(a,r.params);else if(g(r.params))e=a[r.method].fn.apply(a,r.params);else if(v(r.params)){if(!(a[r.method].params instanceof Array))return f.resolve({jsonrpc:"2.0",id:r.id,error:i(O.INVALID_PARAMS,"Undeclared arguments of the method "+r.method)});var n=[];if(a[r.method].params.forEach(function(e){r.params.hasOwnProperty(e)?(n.push(r.params[e]),delete r.params[e]):n.push(void 0)}),0<Object.keys(r.params).length)return f.resolve({jsonrpc:"2.0",id:r.id,error:i(O.INVALID_PARAMS,{message:"Params: "+Object.keys(r.params).toString()+" not used"})});e=a[r.method].fn.apply(a,n)}}else e=a[r.method].fn();return r.hasOwnProperty("id")?function(e){return e&&"function"==typeof e.then}(e)?e.then(function(e){return p(e)&&(e=s.undefinedResult),{jsonrpc:"2.0",id:r.id,result:e}}).catch(function(e){return{jsonrpc:"2.0",id:r.id,error:i(O.INTERNAL_ERROR,e)}}):(p(e)&&(e=s.undefinedResult),f.resolve({jsonrpc:"2.0",id:r.id,result:e})):f.resolve()}catch(e){return f.resolve({jsonrpc:"2.0",id:r.id,error:i(O.INTERNAL_ERROR,e)})}}}(e):f.resolve({id:null,jsonrpc:"2.0",error:i(O.INVALID_REQUEST)})}catch(e){return console.error("Resolver error:"+e.message,e),f.reject(e)}var r,n,t}function c(e,r){e={jsonrpc:"2.0",method:e,params:r};return v(r)&&!h(r)&&(e.params=r),e}function d(e,r,n){e={jsonrpc:"2.0",method:e,id:t+=1};return v(r)&&!h(r)&&(e.params=r),{promise:new f(function(e,r){o[t.toString()]={resolve:e,reject:r}}),message:e,bearer:n}}s.undefinedResult=!0,s.toStream=function(e,r){console.log("Need define the toStream method before use"),console.log(arguments)},s.dispatch=function(e,r,n){if(m(e)&&"pass"==r&&l(n))a[e]={fn:n,params:r};else if(m(e)&&g(r)&&l(n))a[e]={fn:n,params:r};else{if(!(m(e)&&l(r)&&p(n)))throw new Error("Missing required argument: functionName - string, paramsNameFn - string or function");a[e]={fn:r,params:null}}},s.on=s.dispatch,s.off=function(e){delete a[e]},s.call=function(e,r,n){n=d(e,r,n);return s.toStream(JSON.stringify(n.message),n.bearer),n.promise},s.notification=function(e,r){s.toStream(JSON.stringify(c(e,r)))},s.batch=function(e){var n=[],t=[],o=[];return y(e,function(e){var r;e.hasOwnProperty("call")?(r=d(e.call.method,e.call.params),t.push(r.message),o.push(r.bearer),n.push(r.promise.then(function(e){return e},function(e){return e}))):e.hasOwnProperty("notification")&&t.push(c(e.notification.method,e.notification.params))}),s.toStream(JSON.stringify(t),o),f.all(n)},s.messageHandler=function(e){try{var r=JSON.parse(e);return t=[],g(n=r)?y(n,function(e){t.push(u(e))}):v(n)&&t.push(u(n)),f.all(t).then(function(e){var r=[];return y(e,function(e){p(e)||r.push(e)}),1===r.length?s.toStream(JSON.stringify(r[0])):1<r.length&&s.toStream(JSON.stringify(r)),e})}catch(e){return console.log("Error in messageHandler(): ",e),s.toStream(JSON.stringify({id:null,jsonrpc:"2.0",error:O.PARSE_ERROR})),f.reject(e)}var n,t},s.customException=function(e,r,n){return new R(e,r,n)}}if(r.connect_xhr=function(t,o){null==t&&(t="/"),"content-type"in(o=null==o?{}:o)||(o["content-type"]="application/json; charset=utf-8"),"method"in o||(o.method="POST"),"onerror"in o||(o.onerror=console.error);var s=new r;return s.toStream=function(e,r){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==this.readyState)try{JSON.parse(this.responseText),s.messageHandler(this.responseText)}catch(e){o.onerror(e)}},n.open(o.method,t,!0),n.setRequestHeader("Content-type",o["content-type"]),r&&n.setRequestHeader("Authorization","Bearer "+r),n.send(e)},s},"function"==typeof define&&define.amd)define("simple_jsonrpc",[],function(){return r});else if("undefined"!=typeof module&&void 0!==module.exports)module.exports=r;else{if(void 0===e)return;e.simple_jsonrpc=r}}(this);